<!--
Copyright (c) 2014 Long Xiang (seanlong@outlook.com). All rights reserved.
Unauthorized copying of this file, via any medium is strictly prohibited
Proprietary and confidential
-->

<head>
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <script>
    var gui = require('nw.gui');
    var win = gui.Window.get();
    win.maximize();
    </script>

    <script src="./bower_components/webcomponentsjs/webcomponents.js"></script>
    <link rel="import" href="./bower_components/core-pages/core-pages.html">

    <link href="login-page.html" rel="import">
    <link href="user-page.html" rel="import">
    <link href="admin-page.html" rel="import">
    <link href="oil-tank-page.html" rel="import">
    <link href="oil-tank-data.html" rel="import">
    <style>
    body {
        font-family: arial, 'Hiragino Sans GB', 'Microsoft Yahei', '微软雅黑', '宋体', \5b8b\4f53, Tahoma, Arial, Helvetica, STHeiti;
    }
    </style>
</head>

<body fullbleed layout vertical unresolved>
    <polymer-element name='home-page' attributes="oil_tank_data selected">
        <template>
            <style>
            :host,
            core-pages {
                display: block;
                height: 100%;
            }
            </style>
            <oil-tank-data data="{{oil_tank_data}}"></oil-tank-data>
            <core-pages id="pages" selected="{{selected}}" valueattr="label" flex>
                <login-page label="login" id="login_pg"></login-page>
                <user-page label="user" id="user_pg" data="{{oil_tank_data}}"></user-page>
                <admin-page label="admin" id="admin_pg" data="{{oil_tank_data}}"></admin-page>
            </core-pages>
        </template>
        <script>
        Polymer({
            created: function() {
                this.oil_tank_data = [];
            },
            attached: function() {
                this.selected = 0;
                this.prev_selected = 0;
                var that = this;
                this.$.login_pg.addEventListener('login', function(e) {
                    that.selected = e.detail.type;
                });
                document.addEventListener('choose-tank', function(e) {
                    var tank_id = e.detail.id;
                    var tank_label = 'tank_' + tank_id;
                    that.prev_selected = that.selected;
                    var found = false;
                    for (var i in that.$.pages.children) {
                        var e = that.$.pages.children[i];
                        if (e && e.getAttribute && e.getAttribute('label') == tank_label) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        var elem = document.createElement('oil-tank-page');
                        elem.bind('datas', new PathObserver(that, 'oil_tank_data'));
                        elem.bind('home_selected', new PathObserver(that, 'selected'))
                        elem.setAttribute('tank_id', tank_id);
                        elem.setAttribute('label', 'tank_' + tank_id);
                        that.$.pages.appendChild(elem);
                    }
                    that.selected = 'tank_' + tank_id;
                });
                document.addEventListener('logout', function(e) {
                    that.selected = 0;
                    this.prev_selected = 0;
                });
                document.addEventListener('backward', function(e) {
                    that.selected = that.prev_selected;
                });
            }
        });
        </script>
    </polymer-element>

    <home-page id="home"></home-page>
</body>
