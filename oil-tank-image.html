<!--
Copyright (c) 2014 Long Xiang (seanlong@outlook.com). All rights reserved.
Unauthorized copying of this file, via any medium is strictly prohibited
Proprietary and confidential
-->

<script type="text/javascript" src="./bower_components/paper.js/paper-full.min.js"></script>

<polymer-element name='oil-tank-image' attributes="data active">
    <template>
        <style>
        </style>
        <canvas id="oil_tank"></canvas>
    </template>
    <script>
    var fillColor = '#90A4AE';
    var strokeColor = '#424242';
    var papers = [];
    Polymer({
        created: function() {
            this.data = {};
            this.active = true;
            var this_paper = new paper.PaperScope();
            this.paper_idx = papers.push(this_paper) - 1;
        },
        attached: function() {
            var canvas = this.$.oil_tank;
            if (this.type == "small") {
                canvas.width = 220;
                canvas.height = 240;
            } else if (this.type == "large") {
                canvas.width = 420;
                canvas.height = 390;
            }
            papers[this.paper_idx].setup(canvas);
            this.items = [];
            this.draw();
        },
        drawInternal: function(top, left, radius, height) {
            paper = papers[this.paper_idx];
            //TODO make sure this is called necessarily.
            if (this.group)
                this.group.remove();
            var curr_oil_level = Math.min(this.data.oil_level_high / this.data.tank_height, 1);
            var curr_water_level = Math.min(this.data.water_level / this.data.tank_height, 1);
            var center_x = left + radius[0];
            var right = left + radius[0] * 2;
            var bottom = top + height;
            // draw tank and background
            var top_ellipse = new paper.Path.Ellipse({
                center: [center_x, top],
                radius: radius,
                strokeColor: 'black',
                fillColor: 'white'
            });
            var border_rect = new paper.Path.Rectangle({
                rectangle: {
                    topLeft: [left, top],
                    bottomRight: [right, bottom]
                },
                strokeColor: 'black',
                fillColor: 'white',
            });
            var fill_rect = new paper.Path.Rectangle({
                rectangle: {
                    topLeft: [left + 4, top + 2],
                    bottomRight: [right - 4, bottom - 3]
                },
                fillColor: {
                    gradient: {
                        stops: ['white', 'black']
                    },
                    origin: [left + 4, top + 2],
                    destination: [left + 4, bottom - height * curr_oil_level]
                },
                strokeColor: 'black'
            });
            var mask_rect = new paper.Path.Rectangle({
                rectangle: {
                    topLeft: [left + 1, top],
                    bottomRight: [right - 1, bottom]
                },
                fillColor: 'white',
            });
            // draw pillar
            var pillar, pillar_top;
            if (this.type == 'large') {
                pillar = new paper.Path.Rectangle({
                    rectangle: {
                        topLeft: [right - 35, 30],
                        bottomRight: [right - 39, bottom]
                    },
                    strokeColor: 'black',
                    fillColor: 'white'
                });
                pillar_top = new paper.Path.Circle({
                    center: [right - 35 - 2, 30],
                    radius: 7,
                    strokeColor: 'black',
                    fillColor: 'white'
                });
            } else if (this.type == 'small') {
                pillar = new paper.Path.Rectangle({
                    rectangle: {
                        topLeft: [right - 24, 16],
                        bottomRight: [right - 28, bottom]
                    },
                    strokeColor: 'black',
                    fillColor: 'white'
                });
                pillar_top = new paper.Path.Circle({
                    center: [right - 24 - 2, 16],
                    radius: 5,
                    strokeColor: 'black',
                    fillColor: 'white'
                });
            }
            // draw text
            var text1, text2;
            if (this.type == 'large') {
                text1 = new paper.PointText({
                    point: [center_x - 54, top - radius[1] / 2],
                    content: '罐号：' + this.data.tank_id + '号罐',
                    fillColor: 'blue',
                    fontSize: 20,
                    fontWeight: 'bold'
                });
                text2 = new paper.PointText({
                    point: [center_x - 54, top - radius[1] / 2 + 25],
                    content: '油品：' + this.data.oil_type,
                    fillColor: 'red',
                    fontSize: 20,
                    fontWeight: 'bold'
                });
            } else if (this.type == "small") {
                /*
                text1 = new paper.PointText({
                    point: [center_x - 46, top - radius[1] / 2],
                    content: '罐号：' + this.data.tank_id + '号罐',
                    fillColor: 'blue',
                    fontSize: 8,
                    fontWeight: 'bold'
                });
                text2 = new paper.PointText({
                    point: [center_x - 46, top - radius[1] / 2 + 15],
                    content: '油品：' + this.data.oil_type,
                    fillColor: 'red',
                    fontSize: 8,
                    fontWeight: 'bold'
                });
                */
            }
            // draw buoy
            var oil_level, oil_buoy, water_level, water_buoy;
            if (curr_oil_level > 0 && curr_oil_level <= 1) {
                oil_level = new paper.Path.Rectangle({
                    rectangle: {
                        topLeft: [left + 4, bottom - height * curr_oil_level],
                        bottomRight: [right - 4, bottom - 3]
                    },
                    fillColor: '#80D8FF',
                });
                if (this.type == 'large') {
                    oil_buoy = new paper.Path.Circle({
                        center: [right - 35 - 2, bottom - height * curr_oil_level],
                        radius: 7,
                        strokeColor: 'black',
                        fillColor: 'white'
                    });
                } else if (this.type == 'small') {
                    oil_buoy = new paper.Path.Circle({
                        center: [right - 24 - 2, bottom - height * curr_oil_level],
                        radius: 5,
                        strokeColor: 'black',
                        fillColor: 'white'
                    });
                }
            }

            if (curr_water_level > 0 && curr_water_level <= 1 && curr_water_level < curr_oil_level) {
                water_level = new paper.Path.Rectangle({
                    rectangle: {
                        topLeft: [left + 4, bottom - height * curr_water_level],
                        bottomRight: [right - 4, bottom - height * curr_oil_level]
                    },
                    fillColor: '#4CAF50',
                });
                if (this.type == 'large') {
                    water_buoy = new paper.Path.Circle({
                        center: [right - 35 - 2, bottom - height * curr_water_level],
                        radius: 7,
                        strokeColor: 'black',
                        fillColor: 'white'
                    });
                } else if (this.type == 'small') {
                    water_buoy = new paper.Path.Circle({
                        center: [right - 24 - 2, bottom - height * curr_water_level],
                        radius: 5,
                        strokeColor: 'black',
                        fillColor: 'white'
                    });
                }
            }

            var group = new paper.Group();
            this.group = group;
            group.insertChild(0, border_rect);
            group.insertChild(1, top_ellipse);
            group.insertChild(3, mask_rect);
            group.insertChild(4, fill_rect);
            group.insertChild(5, pillar);
            group.insertChild(6, pillar_top);
            if (text1)
                group.insertChild(7, text1);
            if (text2)
                group.insertChild(7, text2);
            if (water_level) {
                group.insertChild(4, water_level);
                group.insertChild(8, water_buoy);
            }
            if (oil_level) {
                group.insertChild(4, oil_level);
                group.insertChild(8, oil_buoy);
            }
            paper.view.draw();
        },
        drawSmall: function() {
            this.drawInternal(50, 20, [90, 30], 140);
        },
        drawLarge: function() {
            this.drawInternal(100, 20, [180, 70], 250);
        },
        draw: function() {
            if (!this.active)
                return;
            if (this.type == 'small') {
                this.drawSmall();
            } else if (this.type == 'large') {
                this.drawLarge();
            }
        },
        publish: {
            type: 'small',
        },
        dataChanged: function() {
            /*
                        console.log('222222');
            if (!this.data.tank_id)
                return;
            this.draw();
            console.log('111111');
            */
        },
        drawbyid: function() {
            console.log('222222');
            this.draw();
            console.log('111111');
        }
    });
    </script>
</polymer-element>
